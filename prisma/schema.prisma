// Prisma Schema for Alina Visitor Parking Pass Application
// Mission-critical healthcare facility parking management system
// PRODUCTION-GRADE with full audit trails, soft deletes, and HIPAA considerations

generator client {
  provider = "prisma-client-js"
  previewFeatures = ["fullTextSearch", "fullTextIndex"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// SYSTEM CONFIGURATION
// ============================================

model SystemConfig {
  id                String   @id @default(cuid())
  key               String   @unique
  value             Json
  description       String?
  isEncrypted       Boolean  @default(false)
  lastModifiedBy    String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([key])
  @@map("system_config")
}

// ============================================
// BUILDING & PROPERTY MANAGEMENT
// ============================================

model Building {
  id          String        @id @default(cuid())
  name        String
  slug        String        @unique // For URL-friendly access
  address     String

  // Contact information
  contactEmail    String?
  contactPhone    String?
  emergencyPhone  String?

  // Configuration
  timezone        String    @default("America/New_York")
  isActive        Boolean   @default(true)

  // Soft delete
  deletedAt       DateTime?

  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  units         Unit[]
  parkingZones  ParkingZone[]
  parkingRules  ParkingRule?
  managers      BuildingManager[]

  @@index([slug])
  @@index([isActive])
  @@map("buildings")
}

model Unit {
  id          String   @id @default(cuid())
  unitNumber  String
  buildingId  String
  building    Building @relation(fields: [buildingId], references: [id], onDelete: Cascade)

  // Unit details
  floor       Int?
  section     String?  // Wing/Section identifier

  // Contact
  primaryPhone    String?
  primaryEmail    String?

  // Status
  isOccupied      Boolean  @default(true)
  isActive        Boolean  @default(true)

  // Soft delete
  deletedAt       DateTime?

  residents     Resident[]
  parkingPasses ParkingPass[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([buildingId, unitNumber])
  @@index([buildingId])
  @@index([isActive])
  @@map("units")
}

model Resident {
  id        String  @id @default(cuid())
  email     String?
  phone     String?
  name      String
  unitId    String
  unit      Unit    @relation(fields: [unitId], references: [id], onDelete: Cascade)

  // Authentication
  userId    String? @unique
  user      User?   @relation(fields: [userId], references: [id])

  // Status
  isPrimary Boolean @default(false)  // Primary contact for unit
  isActive  Boolean @default(true)

  // Notification preferences
  notifyOnVisitorRegistration Boolean @default(true)
  notifyOnViolation          Boolean @default(true)

  // Soft delete
  deletedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([unitId])
  @@index([email])
  @@map("residents")
}

model ParkingZone {
  id           String   @id @default(cuid())
  name         String   // e.g., "Visitor Lot A", "Emergency Bay"
  buildingId   String
  building     Building @relation(fields: [buildingId], references: [id], onDelete: Cascade)

  code         String   // Short code for QR URL
  description  String?
  totalSpots   Int      @default(0) // 0 = unlimited/not tracked

  // Emergency/Priority settings
  isEmergencyZone  Boolean @default(false)
  requiresApproval Boolean @default(false)

  // QR Code
  qrCodeUrl        String?  // Stored QR code image URL
  qrCodeLastGenerated DateTime?

  isActive     Boolean  @default(true)
  deletedAt    DateTime?

  parkingPasses ParkingPass[]
  qrCodeScans   QRCodeScan[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([buildingId, code])
  @@index([buildingId])
  @@index([isActive])
  @@map("parking_zones")
}

// ============================================
// PARKING RULES & CONFIGURATION
// ============================================

model ParkingRule {
  id          String   @id @default(cuid())
  buildingId  String   @unique
  building    Building @relation(fields: [buildingId], references: [id], onDelete: Cascade)

  // Rule configurations
  maxVehiclesPerUnit        Int      @default(2)
  maxConsecutiveHours       Int      @default(24)
  cooldownHours             Int      @default(2)
  maxExtensions             Int      @default(1)
  extensionMaxHours         Int      @default(4)
  requireUnitConfirmation   Boolean  @default(false)

  // Operating hours (null = 24/7)
  operatingStartHour  Int?     // 0-23
  operatingEndHour    Int?     // 0-23

  // Duration options (in hours)
  allowedDurations    Int[]    @default([2, 4, 8, 12, 24])

  // Grace periods
  gracePeriodMinutes  Int      @default(15)  // Grace before violation

  // Emergency overrides
  allowEmergencyOverride Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("parking_rules")
}

// ============================================
// VEHICLES & PARKING PASSES
// ============================================

model Vehicle {
  id            String   @id @default(cuid())
  licensePlate  String   @unique

  // Normalized for searching
  normalizedPlate String  @unique

  // Vehicle details
  make          String?
  model         String?
  color         String?
  state         String?  // License plate state/province

  // Blacklist
  isBlacklisted Boolean  @default(false)
  blacklistReason String?
  blacklistedAt DateTime?
  blacklistedBy String?  // User ID

  // Risk scoring
  violationCount Int     @default(0)
  riskScore      Int     @default(0)  // 0-100, auto-calculated

  // Soft delete
  deletedAt DateTime?

  parkingPasses ParkingPass[]
  violations    Violation[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([normalizedPlate])
  @@index([isBlacklisted])
  @@index([riskScore])
  @@map("vehicles")
}

model ParkingPass {
  id          String   @id @default(cuid())

  vehicleId   String
  vehicle     Vehicle  @relation(fields: [vehicleId], references: [id])

  unitId      String
  unit        Unit     @relation(fields: [unitId], references: [id])

  parkingZoneId String?
  parkingZone   ParkingZone? @relation(fields: [parkingZoneId], references: [id])

  // Timing
  startTime   DateTime
  endTime     DateTime
  duration    Int      // Original duration in hours

  // Extension tracking
  originalEndTime DateTime
  extensionCount  Int       @default(0)
  lastExtendedAt  DateTime?

  // Status
  status      PassStatus @default(ACTIVE)

  // Visitor information
  visitorName  String?
  visitorPhone String?
  visitorEmail String?

  // Pass type
  passType    PassType   @default(VISITOR)

  // Emergency/Priority
  isEmergency Boolean    @default(false)
  priorityLevel Int      @default(0)  // 0=normal, higher=priority

  // Recurring pass settings
  isRecurring     Boolean   @default(false)
  recurringDays   Int[]     // 0=Sun, 1=Mon, etc.
  recurringEndDate DateTime?
  parentPassId    String?

  // Confirmation
  confirmationCode String   @unique @default(cuid())

  // Audit trail
  registeredVia   String    @default("QR_SCAN")
  ipAddress       String?
  userAgent       String?
  deviceInfo      String?

  // Notifications
  confirmationSent    Boolean   @default(false)
  confirmationSentAt  DateTime?
  expirationWarningSent Boolean @default(false)

  // Approval workflow (if required)
  requiresApproval    Boolean   @default(false)
  approvedBy          String?
  approvedAt          DateTime?
  approvalNotes       String?

  // View tracking
  viewCount           Int       @default(0)
  lastViewedAt        DateTime?

  // Soft delete
  deletedAt           DateTime?
  deletedBy           String?
  deletionReason      String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([vehicleId])
  @@index([unitId])
  @@index([status])
  @@index([startTime, endTime])
  @@index([confirmationCode])
  @@index([isEmergency])
  @@index([createdAt])
  @@map("parking_passes")
}

enum PassStatus {
  PENDING
  ACTIVE
  EXPIRED
  CANCELLED
  EXTENDED
  SUSPENDED
}

enum PassType {
  VISITOR
  RECURRING
  TEMPORARY_RESIDENT
  SERVICE_PROVIDER
  MEDICAL_STAFF
  EMERGENCY
  VENDOR
}

// ============================================
// VIOLATIONS & ENFORCEMENT
// ============================================

model Violation {
  id          String   @id @default(cuid())

  vehicleId   String
  vehicle     Vehicle  @relation(fields: [vehicleId], references: [id])

  type        ViolationType
  description String?
  severity    ViolationSeverity @default(MEDIUM)

  // Location
  location    String?
  parkingZoneId String?

  // Evidence
  photoUrls   String[]
  evidenceNotes String?

  // Resolution
  isResolved  Boolean  @default(false)
  resolvedAt  DateTime?
  resolvedBy  String?
  resolution  String?

  // Enforcement
  citationNumber String? @unique
  fineAmount     Decimal? @db.Decimal(10, 2)
  isPaid         Boolean  @default(false)

  // Logged by
  loggedById  String
  loggedBy    User     @relation(fields: [loggedById], references: [id])

  // Soft delete
  deletedAt   DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([vehicleId])
  @@index([type])
  @@index([severity])
  @@index([isResolved])
  @@index([createdAt])
  @@map("violations")
}

enum ViolationType {
  OVERSTAY
  UNREGISTERED
  IMPROPER_PARKING
  BLOCKING
  RESERVED_SPOT
  EXPIRED_PASS
  FRAUDULENT_REGISTRATION
  EMERGENCY_LANE_VIOLATION
  HANDICAP_VIOLATION
  OTHER
}

enum ViolationSeverity {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

// ============================================
// USER & AUTHENTICATION
// ============================================

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  name          String?
  passwordHash  String?
  role          UserRole  @default(MANAGER)

  emailVerified DateTime?
  image         String?

  // Security
  twoFactorEnabled Boolean  @default(false)
  twoFactorSecret  String?

  // Status
  isActive      Boolean   @default(true)
  isSuspended   Boolean   @default(false)
  suspendedAt   DateTime?
  suspensionReason String?

  // Login tracking
  lastLoginAt   DateTime?
  lastLoginIp   String?
  failedLoginAttempts Int @default(0)
  lastFailedLoginAt   DateTime?

  // Soft delete
  deletedAt     DateTime?

  // Relations
  managedBuildings BuildingManager[]
  violations       Violation[]
  auditLogs        AuditLog[]
  resident         Resident?
  accounts         Account[]
  sessions         Session[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([email])
  @@index([isActive])
  @@map("users")
}

enum UserRole {
  SUPER_ADMIN
  ADMIN
  MANAGER
  SECURITY
  RESIDENT
}

model BuildingManager {
  id          String   @id @default(cuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  buildingId  String
  building    Building @relation(fields: [buildingId], references: [id], onDelete: Cascade)

  // Permissions
  canManageUnits      Boolean @default(false)
  canManageViolations Boolean @default(true)
  canManageSettings   Boolean @default(false)
  canExportData       Boolean @default(false)

  isActive    Boolean  @default(true)
  deletedAt   DateTime?

  createdAt DateTime @default(now())

  @@unique([userId, buildingId])
  @@index([buildingId])
  @@map("building_managers")
}

// Auth.js required tables
model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId])
  @@map("accounts")
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("sessions")
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
  @@map("verification_tokens")
}

// ============================================
// AUDIT & ANALYTICS
// ============================================

model AuditLog {
  id        String     @id @default(cuid())
  action    AuditAction
  entityType String
  entityId  String
  details   Json?

  userId    String?
  user      User?      @relation(fields: [userId], references: [id])

  ipAddress String?
  userAgent String?

  // Compliance
  dataAccessed String[]  @default([])

  createdAt DateTime @default(now())

  @@index([entityType, entityId])
  @@index([userId])
  @@index([action])
  @@index([createdAt])
  @@map("audit_logs")
}

enum AuditAction {
  CREATE
  READ
  UPDATE
  DELETE
  LOGIN
  LOGOUT
  LOGIN_FAILED
  EXTEND_PASS
  CANCEL_PASS
  LOG_VIOLATION
  RESOLVE_VIOLATION
  BLACKLIST_VEHICLE
  EXPORT_DATA
  SETTING_CHANGE
  EMERGENCY_ACCESS
}

model QRCodeScan {
  id            String   @id @default(cuid())
  parkingZoneId String?
  parkingZone   ParkingZone? @relation(fields: [parkingZoneId], references: [id])
  buildingId    String?

  ipAddress     String?
  userAgent     String?
  deviceInfo    String?

  resultedInPass Boolean @default(false)
  passId         String?

  // Location data (optional)
  latitude       Decimal? @db.Decimal(10, 8)
  longitude      Decimal? @db.Decimal(11, 8)

  createdAt DateTime @default(now())

  @@index([parkingZoneId])
  @@index([buildingId])
  @@index([createdAt])
  @@map("qr_code_scans")
}

// ============================================
// NOTIFICATIONS
// ============================================

model NotificationQueue {
  id          String   @id @default(cuid())
  type        NotificationType
  recipient   String   // Email or phone
  subject     String?
  body        String

  status      NotificationStatus @default(PENDING)
  attempts    Int      @default(0)
  maxAttempts Int      @default(3)

  scheduledFor DateTime @default(now())
  sentAt       DateTime?
  failedAt     DateTime?
  errorMessage String?

  // Context
  entityType   String?
  entityId     String?
  metadata     Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([status])
  @@index([scheduledFor])
  @@index([type])
  @@map("notification_queue")
}

enum NotificationType {
  EMAIL
  SMS
  PUSH
}

enum NotificationStatus {
  PENDING
  SENT
  FAILED
  CANCELLED
}

// ============================================
// SYSTEM MONITORING
// ============================================

model SystemHealth {
  id              String   @id @default(cuid())

  // Metrics
  activePassCount Int
  expiringSoonCount Int
  violationCount  Int

  // Performance
  avgResponseTime Float
  errorRate       Float

  // Resources
  dbConnectionCount Int?

  // Status
  overallStatus   HealthStatus

  checkedAt DateTime @default(now())

  @@index([checkedAt])
  @@map("system_health")
}

enum HealthStatus {
  HEALTHY
  DEGRADED
  CRITICAL
}
